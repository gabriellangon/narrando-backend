name: Build & Publish Narrando API (GHCR)

on:
  push:
    branches: [ main, develop, staging ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: narrando-api

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create test environment
      run: |
        cp .env.example .env.test
        mkdir -p data/backup data/audio

    - name: Test API endpoints (without external APIs)
      env:
        # Variables minimum pour permettre l'import des clients
        GOOGLE_PLACES_API_KEY: dummy-key-for-testing
        PERPLEXITY_API_KEY: dummy-key-for-testing
        SUPABASE_URL: https://dummy.supabase.co
        SUPABASE_ANON_KEY: dummy-anon-key
        SUPABASE_SERVICE_KEY: dummy-service-key
      run: |
        # Test basic imports
        python -c "
        import sys
        sys.path.append('.')
        from api import app
        print('âœ… API imports OK')
        "
        
        # Test health endpoint
        python -c "
        import sys
        sys.path.append('.')
        from api import app
        with app.test_client() as client:
            response = client.get('/health')
            assert response.status_code == 200
            print('âœ… Health endpoint OK')
        "

    - name: Test Docker build
      run: |
        docker build -t $IMAGE_NAME .
        echo "âœ… Docker build successful"

  deploy-staging:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    
    environment: staging
    
    outputs:
      image_tag: ${{ steps.push-image.outputs.image_tag }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image to GHCR
      id: push-image
      run: |
        IMAGE_TAG="${REGISTRY}/${GITHUB_REPOSITORY_OWNER,,}/${IMAGE_NAME}:staging-${GITHUB_SHA}"
        LATEST_TAG="${REGISTRY}/${GITHUB_REPOSITORY_OWNER,,}/${IMAGE_NAME}:staging-latest"

        docker build -t $IMAGE_NAME .
        docker tag $IMAGE_NAME:latest $IMAGE_TAG
        docker tag $IMAGE_NAME:latest $LATEST_TAG

        docker push $IMAGE_TAG
        docker push $LATEST_TAG

        echo "âœ… Image pushed: $IMAGE_TAG"
        echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

  deploy-staging-vps:
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Add SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}

    - name: Add VPS host to known_hosts
      run: |
        mkdir -p ~/.ssh
        PORT="${{ secrets.STAGING_SSH_PORT }}"
        HOST="${{ secrets.STAGING_SSH_HOST }}"
        ssh-keyscan -p "${PORT:-22}" "${HOST}" >> ~/.ssh/known_hosts

    - name: Deploy image on VPS
      env:
        IMAGE_TAG: ${{ needs.deploy-staging.outputs.image_tag }}
        VPS_HOST: ${{ secrets.STAGING_SSH_HOST }}
        VPS_USER: ${{ secrets.STAGING_SSH_USER }}
        VPS_PORT: ${{ secrets.STAGING_SSH_PORT }}
        APP_DIR: ${{ secrets.STAGING_APP_DIR }}
        CONTAINER_NAME: narrando-api
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_ACTOR: ${{ github.actor }}
      run: |
        ssh -p "${VPS_PORT:-22}" "${VPS_USER}@${VPS_HOST}" <<EOF
        set -euo pipefail

        APP_DIR="${APP_DIR:-/srv/narrando}"
        DATA_DIR="\${APP_DIR}/data"
        LOGS_DIR="\${APP_DIR}/logs"
        ENV_FILE="\${APP_DIR}/.env"

        mkdir -p "\${APP_DIR}" "\${DATA_DIR}" "\${LOGS_DIR}"

        echo "ðŸ” Logging into GHCR"
        echo "${GITHUB_TOKEN}" | docker login ghcr.io -u "${GITHUB_ACTOR}" --password-stdin

        echo "â¬‡ï¸  Pulling image ${IMAGE_TAG}"
        docker pull "${IMAGE_TAG}"

        echo "ðŸ›‘ Stopping old container if present"
        docker stop "${CONTAINER_NAME}" >/dev/null 2>&1 || true
        docker rm "${CONTAINER_NAME}" >/dev/null 2>&1 || true

        echo "ðŸš€ Starting container ${CONTAINER_NAME}"
        docker run -d \
          --name "${CONTAINER_NAME}" \
          --env-file "\${ENV_FILE}" \
          -p 5000:5000 \
          -v "\${DATA_DIR}:/app/data" \
          -v "\${LOGS_DIR}:/app/logs" \
          "${IMAGE_TAG}"

        docker ps --filter "name=\${CONTAINER_NAME}"
        EOF

  deploy-production:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    
    environment: production
    
    outputs:
      image_tag: ${{ steps.push-image.outputs.image_tag }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image to GHCR
      id: push-image
      run: |
        IMAGE_TAG="${REGISTRY}/${GITHUB_REPOSITORY_OWNER,,}/${IMAGE_NAME}:prod-${GITHUB_SHA}"
        LATEST_TAG="${REGISTRY}/${GITHUB_REPOSITORY_OWNER,,}/${IMAGE_NAME}:prod-latest"

        docker build -t $IMAGE_NAME .
        docker tag $IMAGE_NAME:latest $IMAGE_TAG
        docker tag $IMAGE_NAME:latest $LATEST_TAG

        docker push $IMAGE_TAG
        docker push $LATEST_TAG

        echo "âœ… Image pushed: $IMAGE_TAG"
        echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

  deploy-production-vps:
    needs: deploy-production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Add SSH key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

    - name: Add VPS host to known_hosts
      run: |
        mkdir -p ~/.ssh
        PORT="${{ secrets.PROD_SSH_PORT }}"
        HOST="${{ secrets.PROD_SSH_HOST }}"
        ssh-keyscan -p "${PORT:-22}" "${HOST}" >> ~/.ssh/known_hosts

    - name: Deploy image on VPS
      env:
        IMAGE_TAG: ${{ needs.deploy-production.outputs.image_tag }}
        VPS_HOST: ${{ secrets.PROD_SSH_HOST }}
        VPS_USER: ${{ secrets.PROD_SSH_USER }}
        VPS_PORT: ${{ secrets.PROD_SSH_PORT }}
        APP_DIR: ${{ secrets.PROD_APP_DIR }}
        CONTAINER_NAME: narrando-api
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_ACTOR: ${{ github.actor }}
      run: |
        ssh -p "${VPS_PORT:-22}" "${VPS_USER}@${VPS_HOST}" <<EOF
        set -euo pipefail

        APP_DIR="${APP_DIR:-/srv/narrando}"
        DATA_DIR="\${APP_DIR}/data"
        LOGS_DIR="\${APP_DIR}/logs"
        ENV_FILE="\${APP_DIR}/.env"

        mkdir -p "\${APP_DIR}" "\${DATA_DIR}" "\${LOGS_DIR}"

        echo "ðŸ” Logging into GHCR"
        echo "${GITHUB_TOKEN}" | docker login ghcr.io -u "${GITHUB_ACTOR}" --password-stdin

        echo "â¬‡ï¸  Pulling image ${IMAGE_TAG}"
        docker pull "${IMAGE_TAG}"

        echo "ðŸ›‘ Stopping old container if present"
        docker stop "${CONTAINER_NAME}" >/dev/null 2>&1 || true
        docker rm "${CONTAINER_NAME}" >/dev/null 2>&1 || true

        echo "ðŸš€ Starting container ${CONTAINER_NAME}"
        docker run -d \
          --name "${CONTAINER_NAME}" \
          --env-file "\${ENV_FILE}" \
          -p 5000:5000 \
          -v "\${DATA_DIR}:/app/data" \
          -v "\${LOGS_DIR}:/app/logs" \
          "${IMAGE_TAG}"

        docker ps --filter "name=\${CONTAINER_NAME}"
        EOF
