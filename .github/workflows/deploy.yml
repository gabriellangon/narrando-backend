name: Build & Publish Narrando API (GHCR)

on:
  push:
    branches: [ main, develop, staging ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: narrando-api

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create test environment
      run: |
        cp .env.example .env.test
        mkdir -p data/backup data/audio

    - name: Test API endpoints (without external APIs)
      env:
        # Variables minimum pour permettre l'import des clients
        GOOGLE_PLACES_API_KEY: dummy-key-for-testing
        PERPLEXITY_API_KEY: dummy-key-for-testing
        SUPABASE_URL: https://dummy.supabase.co
        SUPABASE_ANON_KEY: dummy-anon-key
        SUPABASE_SERVICE_KEY: dummy-service-key
      run: |
        # Test basic imports
        python -c "
        import sys
        sys.path.append('.')
        from api import app
        print('✅ API imports OK')
        "
        
        # Test health endpoint
        python -c "
        import sys
        sys.path.append('.')
        from api import app
        with app.test_client() as client:
            response = client.get('/health')
            assert response.status_code == 200
            print('✅ Health endpoint OK')
        "

    - name: Test Docker build
      run: |
        docker build -t $IMAGE_NAME .
        echo "✅ Docker build successful"

  deploy-staging:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    
    environment: staging
    
    outputs:
      image_tag: ${{ steps.push-image.outputs.image_tag }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image to GHCR
      id: push-image
      run: |
        IMAGE_TAG="${REGISTRY}/${GITHUB_REPOSITORY_OWNER,,}/${IMAGE_NAME}:staging-${GITHUB_SHA}"
        LATEST_TAG="${REGISTRY}/${GITHUB_REPOSITORY_OWNER,,}/${IMAGE_NAME}:staging-latest"

        docker build -t $IMAGE_NAME .
        docker tag $IMAGE_NAME:latest $IMAGE_TAG
        docker tag $IMAGE_NAME:latest $LATEST_TAG

        docker push $IMAGE_TAG
        docker push $LATEST_TAG

        echo "✅ Image pushed: $IMAGE_TAG"
        echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT

  deploy-production:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    
    environment: production
    
    outputs:
      image_tag: ${{ steps.push-image.outputs.image_tag }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image to GHCR
      id: push-image
      run: |
        IMAGE_TAG="${REGISTRY}/${GITHUB_REPOSITORY_OWNER,,}/${IMAGE_NAME}:prod-${GITHUB_SHA}"
        LATEST_TAG="${REGISTRY}/${GITHUB_REPOSITORY_OWNER,,}/${IMAGE_NAME}:prod-latest"

        docker build -t $IMAGE_NAME .
        docker tag $IMAGE_NAME:latest $IMAGE_TAG
        docker tag $IMAGE_NAME:latest $LATEST_TAG

        docker push $IMAGE_TAG
        docker push $LATEST_TAG

        echo "✅ Image pushed: $IMAGE_TAG"
        echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
